# Парсер тибетских иероглифов

Парсер для сбора изображений тибетских текстов с сайта [adarshah.org](https://online.adarshah.org/) для создания датасета синтетических тибетских иероглифов.

## Описание

Этот парсер собирает:
- **Изображения** тибетских текстов (сканы древних манускриптов)
- **Текстовые расшифровки** (тибетский текст в Unicode)
- **Метаданные** о каждой странице

Данные предназначены для обучения генератора синтетических тибетских иероглифов по методологии из статьи "Evaluation of Egyptian Hieroglyph Classification Across Diverse Writing Styles".

### Ключевые особенности

✅ **Точное сопоставление**: Парсер правильно определяет какой текст относится к какому изображению, используя маркеры страниц и атрибуты data-pbname  
✅ **Надежность**: Обработка ошибок и несколько методов извлечения данных  
✅ **Асинхронность**: Быстрая загрузка данных  
✅ **Метаданные**: Полная информация о каждой странице в JSON формате  
✅ **Отладка**: Сохранение HTML для анализа проблем

## Установка

### 1. Установите зависимости Python

```bash
pip install -r requirements.txt
```

### 2. Установите браузер Chromium для Playwright

```bash
python -m playwright install chromium
```

## Использование

### Базовое использование

Парсинг первых 10 страниц тома 1:

```bash
python tibetan_parser.py
```

### Расширенное использование

#### Парсинг конкретного диапазона страниц

```bash
# Парсинг страниц 1-20 из тома 1
python tibetan_parser.py --start-page 1 --end-page 20

# Парсинг нескольких томов
python tibetan_parser.py --start-vol 1 --end-vol 3 --start-page 1 --end-page 50
```

#### Парсинг конкретных страниц

```bash
# Парсинг определенных страниц
python tibetan_parser.py --pages 1-1b 1-2a 1-2b 1-3a

# Проверка работы на одной странице
python tibetan_parser.py --pages 1-1b
```

#### Ограничение количества страниц

```bash
# Парсинг максимум 5 страниц (для тестирования)
python tibetan_parser.py --max-pages 5
```

#### Указание директории вывода

```bash
# Сохранение в другую директорию
python tibetan_parser.py --output my_dataset
```

## Структура выходных данных

После запуска парсера создается следующая структура:

```
tibetan_data/
├── images/              # Изображения страниц
│   ├── 1-1b.png
│   ├── 1-2a.png
│   └── ...
├── texts/               # Текстовые расшифровки
│   ├── 1-1b.txt
│   ├── 1-2a.txt
│   └── ...
└── metadata.json        # Метаданные о всех страницах
```

### Формат metadata.json

```json
[
  {
    "page_id": "1-1b",
    "image_file": "1-1b.png",
    "text_file": "1-1b.txt",
    "url": "https://online.adarshah.org/index.html?kdb=degekangyur&sutra=d1&page=1-1b",
    "scraped_at": "2025-10-19T10:30:00",
    "text_preview": "༄༅༅། །རྒྱ་གར་སྐད་དུ། བི་ན་ཡ་བསྟུ། བོད་སྐད་དུ། འདུལ་བ་གཞི། བམ་པོ་དང་པོ། དཀོན་མཆོག་གསུམ་ལ་ཕྱག་འཚལ་ལོ། །གང་གིས་འཆིང་..."
  }
]
```

## Примеры команд

### Быстрый тест

```bash
# Проверка на 1 странице
python tibetan_parser.py --pages 1-1b --output test_output
```

### Полный сбор данных для первого тома

```bash
# Парсинг всех страниц первого тома (примерно 200-400 страниц)
python tibetan_parser.py --start-vol 1 --end-vol 1 --start-page 1 --end-page 200
```

### Сбор большого датасета

```bash
# Парсинг первых 3 томов
python tibetan_parser.py --start-vol 1 --end-vol 3 --start-page 1 --end-page 300 --output large_dataset
```

## Особенности реализации

1. **Правильное сопоставление изображений и текстов**: Парсер точно определяет какой текст относится к какому изображению, используя уникальные идентификаторы страниц.

2. **Обработка динамического контента**: Использует Playwright для работы с JavaScript-сайтом.

3. **Асинхронность**: Эффективная асинхронная загрузка данных.

4. **Обработка ошибок**: Устойчив к сетевым ошибкам и пропускает проблемные страницы.

5. **Метаданные**: Сохраняет полную информацию о каждой странице для дальнейшего использования.

## Решение проблем

### Ошибка "No module named playwright"

```bash
pip install playwright
python -m playwright install chromium
```

### Слишком медленная работа

Увеличьте таймауты или уменьшите количество страниц:

```bash
python tibetan_parser.py --max-pages 10
```

### Пустые изображения или тексты

Сайт может иметь различную структуру для разных томов/сутр. Проверьте конкретную страницу вручную и при необходимости адаптируйте селекторы в коде.

## Дальнейшее использование данных

Собранные данные можно использовать для:

1. **Обучения синтетического генератора** тибетских иероглифов
2. **OCR-систем** для распознавания тибетского текста
3. **Анализа стилей письма** в разных манускриптах
4. **Создания аугментированных данных** для обучения нейросетей

## Анализ собранных данных

После сбора данных вы можете проанализировать датасет:

```bash
python analyze_dataset.py --dir tibetan_data
```

Этот скрипт покажет:
- Общую статистику (количество страниц, изображений, текстов)
- Статистику по длине текстов
- Распределение по томам
- Проблемные страницы
- Размер датасета

## Структура кода

- `improved_parser.py` - Основной парсер (рекомендуется)
- `tibetan_parser.py` - Базовая версия парсера
- `inspect_site.py` - Скрипт для исследования структуры сайта
- `analyze_dataset.py` - Анализ собранного датасета

## Проверка качества данных

### Пример проверки текста для страницы 1-1b

Правильный текст для страницы 1-1b должен начинаться с:
```
༄༅༅། །རྒྱ་གར་སྐད་དུ། བི་ན་ཡ་བསྟུ། བོད་སྐད་དུ། འདུལ་བ་གཞི། བམ་པོ་དང་པོ། དཀོན་མཆོག་གསུམ་ལ་ཕྱག་འཚལ་ལོ། །གང་གིས་འཆིང་
རྣམས་ཡང་དག་རབ་བཅད་ཅིང་། །མུ་སྟེགས་ཚོགས་རྣམས་ཐམས་ཅད་རབ་བཅོམ་སྟེ། །སྡེ་དང་བཅས་པའི་བདུད་རྣམས་ངེས་བཅོམ་ནས། །བྱང་ཆུབ་འདི་བརྙེས་དེ་ལ་
ཕྱག་འཚལ་ལོ། །
```

### Проверка соответствия

```bash
# Проверить первые строки текста
head -3 tibetan_data/texts/1-1b.txt

# Убедиться что изображение существует
ls -lh tibetan_data/images/1-1b.png
```

## Использование в ML

Собранные данные можно использовать для:

1. **Обучения VAE/GAN** для генерации синтетических изображений тибетских символов
2. **Стилизации** - перенос стиля древних манускриптов на современный текст  
3. **OCR систем** - обучение распознавания рукописного тибетского текста
4. **Аугментации данных** - создание вариаций существующих символов
5. **Исследований стилей письма** - анализ различных стилей тибетской каллиграфии

### Рекомендуемый пайплайн

1. Соберите датасет (500-1000+ страниц для хорошего качества)
2. Сегментируйте изображения на отдельные символы/строки
3. Выровняйте символы с текстовыми расшифровками
4. Обучите генеративную модель (VAE/StyleGAN)
5. Генерируйте синтетические данные с различными стилями

## Troubleshooting

### Ошибка "No module named playwright"

```bash
source venv/bin/activate
pip install playwright
python -m playwright install chromium
```

### Пустые изображения или тексты

Структура сайта могла измениться. Запустите:

```bash
python inspect_site.py
```

Это откроет браузер и сохранит скриншот + HTML для анализа.

### Медленная работа

Используйте параметры для контроля скорости:

```bash
# Ограничить количество страниц
python improved_parser.py --max-pages 10

# Парсить конкретные страницы
python improved_parser.py --pages 1-1b 1-2a
```

## Лицензия и использование

При использовании данных с сайта adarshah.org соблюдайте условия использования ресурса и указывайте источник данных.

**Источник данных**: [adarshah.org - 84000 Digital Tibetan Canon](https://online.adarshah.org/)

## Автор

Создано для исследований в области ML и генерации синтетических тибетских иероглифов на основе методологии из статьи "Evaluation of Egyptian Hieroglyph Classification Across Diverse Writing Styles".
